# 故障排查指南

本文档提供常见问题的排查和解决方法。

## 启动问题

### 问题：无法启动程序

**错误信息：**
```
配置文件不存在: /path/to/config.json
```

**解决方法：**
1. 确认 `config.json` 文件存在于项目根目录
2. 检查文件名是否正确（不是 `config.json.example`）
3. 确认文件权限可读

---

### 问题：配置验证失败

**错误信息：**
```
配置验证失败:
feishu.app_id 不能为空
```

**解决方法：**
1. 打开 `config.json` 检查所有必填字段
2. 确认字段值不为空字符串
3. 参考 `CONFIGURATION.md` 填写正确的配置

---

### 问题：依赖安装失败

**错误信息：**
```
npm ERR! Could not resolve dependency
```

**解决方法：**
```bash
# 清除缓存
pnpm store prune

# 删除 node_modules
rm -rf node_modules pnpm-lock.yaml

# 重新安装
pnpm install
```

---

## 飞书 API 问题

### 问题：获取 token 失败

**错误信息：**
```
获取飞书 token 失败: 请求失败 status: 401
```

**解决方法：**
1. 检查 `app_id` 和 `app_secret` 是否正确
2. 登录飞书开放平台确认应用状态
3. 确认应用权限是否包含"多维表格"
4. 检查网络是否可以访问 `open.feishu.cn`

---

### 问题：无法获取记录

**错误信息：**
```
获取飞书记录失败: 404 Not Found
```

**解决方法：**
1. 检查 `app_token` 是否正确
2. 检查 `table_id` 是否正确
3. 确认应用是否有该表格的读取权限
4. 在飞书多维表格 URL 中重新提取 token 和 ID

**URL 格式：**
```
https://xxx.feishu.cn/base/{app_token}?table={table_id}&view=xxx
                            ^^^^^^^^^         ^^^^^^^^
```

---

### 问题：API 返回权限错误

**错误信息：**
```
API 调用失败: 权限不足
```

**解决方法：**
1. 确认应用已开通"多维表格"权限
2. 检查应用是否有该表格的访问权限
3. 重新授权应用访问表格
4. 确认使用的是正确的 `/records/search` 接口

---

### 问题：筛选条件不生效

**可能原因：**
- 字段名不匹配
- 筛选值格式错误
- 接口参数格式不正确

**检查步骤：**
1. 确认字段名与飞书表格中的完全一致（包括空格）
2. 确认使用 POST 方法和 `/records/search` 端点
3. 确认请求体格式正确：
   ```json
   {
     "filter": {
       "conjunction": "and",
       "conditions": [
         {
           "field_name": "当前状态",
           "operator": "is",
           "value": ["待上传"]
         }
       ]
     }
   }
   ```

---

### 问题：字段名不匹配

**错误信息：**
```
记录 xxx 缺少必填字段，跳过
```

**解决方法：**
1. 检查飞书表格中的字段名是否为中文
2. 字段名必须完全匹配：
   - "当前状态"（不能是"状态"）
   - "账户"
   - "剧名"
   - "日期"
3. 如果字段名不同，修改 `config.json` 中的 `fields` 配置

---

## 本地文件问题

### 问题：找不到本地目录

**错误信息：**
```
日期目录不存在: D:\短剧剪辑\12.24 导出
```

**解决方法：**
1. 检查 `rootDir` 配置是否正确
2. 确认目录名格式：`MM.DD 导出`（如 `12.24 导出`）
3. 检查日期转换是否正确（YYYY-MM-DD → MM.DD 导出）
4. 确认目录权限可读

**目录检查：**
```bash
# Windows
dir "D:\短剧剪辑\12.24 导出"

# 查看完整路径
cd "D:\短剧剪辑"
dir
```

---

### 问题：找不到剧目录

**错误信息：**
```
剧目录不存在: D:\短剧剪辑\12.24 导出\她醒了
```

**解决方法：**
1. 确认剧名精准匹配（区分大小写、标点符号）
2. 检查是否有多余的空格
3. 确认目录名与飞书表格中的剧名完全一致

**目录名检查：**
```bash
# 列出所有剧目录
dir "D:\短剧剪辑\12.24 导出"
```

---

### 问题：目录下没有 MP4 文件

**错误信息：**
```
目录下没有 MP4 文件: D:\短剧剪辑\12.24 导出\她醒了
```

**解决方法：**
1. 确认目录下有 `.mp4` 文件（扩展名小写）
2. 检查文件是否可读
3. 确认文件未被其他程序占用

---

## Playwright 问题

### 问题：浏览器启动失败

**错误信息：**
```
初始化浏览器失败: browserType.launch: Executable doesn't exist
```

**解决方法：**
```bash
# 安装 Playwright 浏览器
pnpm exec playwright install chromium

# 如果还是失败，完整安装
pnpm exec playwright install --with-deps chromium
```

---

### 问题：页面加载超时

**错误信息：**
```
page.goto: Timeout 60000ms exceeded
```

**解决方法：**
1. 检查网络连接
2. 确认可以访问巨量创意后台
3. 增加超时时间（修改代码中的 timeout 参数）
4. 检查是否有防火墙或代理设置

---

### 问题：找不到页面元素

**错误信息：**
```
waiting for locator('button:has-text('上传视频')') to be visible
```

**解决方法：**
1. 打开浏览器开发者工具（F12）
2. 使用选择器工具检查元素
3. 更新 `config.json` 中的选择器

**调整选择器步骤：**
```
1. 在浏览器中找到目标元素
2. 右键 → 检查
3. 查看元素的 class、id、text 等属性
4. 编写合适的选择器
5. 在控制台测试：document.querySelector('your-selector')
```

**常用选择器：**
```javascript
// 文本匹配
"button:has-text('上传')"

// Class 选择器
".upload-btn"

// ID 选择器
"#uploadButton"

// 属性选择器
"button[data-action='upload']"

// 组合选择器
".video-uploader button.primary"
```

---

### 问题：登录状态丢失

**错误信息：**
（页面跳转到登录页）

**解决方法：**
1. 第一次运行时，程序会打开浏览器
2. 手动登录巨量创意后台
3. 登录状态会保存在 `playwright-state` 目录
4. 后续运行会自动使用保存的登录状态
5. 如果状态丢失，删除 `playwright-state` 重新登录

---

## 上传问题

### 问题：上传卡住不动

**可能原因：**
1. 网络速度慢
2. 文件过大
3. 页面元素选择器不正确
4. 等待时间不够

**解决方法：**
1. 检查网络连接速度
2. 查看浏览器中的实际状态
3. 检查日志文件中的详细信息
4. 调整 `config.json` 中的延迟时间
5. 增加 `slowMo` 参数值

---

### 问题：部分文件上传失败

**错误信息：**
```
第 2/5 批上传失败
```

**解决方法：**
1. 检查失败的文件是否损坏
2. 确认文件大小和格式符合要求
3. 查看浏览器中的错误提示
4. 减小 `batchSize`，单批文件少一些
5. 增加批次间延迟时间

---

### 问题：飞书状态更新失败

**错误信息：**
```
飞书状态更新失败
```

**解决方法：**
1. 文件已经上传成功，但状态未更新
2. 检查飞书 API 权限（需要写入权限）
3. 检查网络连接
4. 手动在飞书表格中更新状态
5. 下次运行时不会重复上传（因为状态仍为"待上传"会重新尝试）

---

## 性能问题

### 问题：程序运行缓慢

**优化方法：**
1. 减小 `slowMo` 参数（或设为 0）
2. 减小批次间延迟时间
3. 增大 `batchSize`（网络允许的情况下）
4. 检查磁盘 I/O 性能

---

### 问题：内存占用过高

**解决方法：**
1. 定期清理已完成的任务（程序会自动清理）
2. 减小 `batchSize`
3. 确保及时关闭不需要的浏览器页面
4. 检查是否有内存泄漏（重启程序）

---

## 日志分析

### 查看日志文件

```bash
# Windows
type logs\upload.log

# 查看最后 100 行
Get-Content logs\upload.log -Tail 100

# 搜索错误
findstr /i "error" logs\upload.log
```

### 日志级别

- `DEBUG`: 详细的调试信息
- `INFO`: 一般信息
- `WARN`: 警告信息
- `ERROR`: 错误信息

### 关键日志信息

1. **任务开始**
   ```
   [INFO] 任务开始 - 剧名: 她醒了, 日期: 2025-12-24, 账户: xxx
   ```

2. **路径检查**
   ```
   [INFO] 路径检查通过: D:\短剧剪辑\12.24 导出\她醒了
   ```

3. **文件扫描**
   ```
   [INFO] 扫描到 25 个 MP4 文件
   ```

4. **上传批次**
   ```
   [INFO] 开始上传第 1/3 批 (10 个文件)
   ```

5. **任务完成**
   ```
   [INFO] 任务完成 - 共上传 25 个文件, 分 3 批
   ```

---

## 紧急处理

### 立即停止程序

```
按 Ctrl + C
```

程序会执行优雅关闭：
1. 停止接受新任务
2. 完成当前任务（如果可能）
3. 关闭浏览器
4. 保存状态

### 强制终止

如果程序无响应：

```bash
# Windows
taskkill /F /IM node.exe

# 或在任务管理器中结束 Node.js 进程
```

---

## 获取帮助

如果以上方法都无法解决问题：

1. **检查日志文件**
   - `logs/upload.log` 包含详细的运行信息

2. **保留错误现场**
   - 不要关闭浏览器窗口
   - 截图错误信息
   - 复制完整的错误堆栈

3. **提供以下信息**
   - 错误信息
   - 日志文件相关部分
   - 配置文件（隐藏敏感信息）
   - 操作系统版本
   - Node.js 版本
   - 重现步骤

